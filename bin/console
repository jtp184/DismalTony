#!/usr/bin/env ruby

require 'bundler/setup'
require 'dismaltony'

# You can add fixtures and/or initialization code here to make experimenting
# with your gem easier. You can also use a different console, if you like.
require 'psych'
require 'ParseyParse'
@laptop_emoji = DismalTony::EmojiDictionary['laptop']

# @db = DismalTony::LocalStore.load_from('./store.yml')

module DismalTony::Directives
  class DrinkMixDirective < DismalTony::Directive
    set_name :drinkmix
    set_group :fun
    add_param :drink, 'Old Fashioned'

    add_criteria do |qry|
      qry << must { |q| q.verb =~ /mix/i}
      qry << should { |q| q.children_of(q.verb).any? { |c| c =~ /drink/i } }
      qry << should { |q| q =~ /please/i }
    end

    def run
      DismalTony::HandledResponse.finish("Okay, #{query.user['nickname']}. Have a #{parameters[:drink]}!")
    end
  end

  class GreetingDirective < DismalTony::Directive
    set_name :hello
    set_group :fun

    add_criteria do |qry|
      qry << must { |q| !q['rel', 'discourse'].empty? }
    end

    def run
      if query =~ /how are you/i
        DismalTony::HandledResponse.finish("~e:thumbsup I'm doing well!")
      else
        DismalTony::HandledResponse.finish ['~e:wave Hello!', '~e:smile Greetings!', '~e:rocket Hi!', "~e:star Hello, #{query.user['nickname']}!", '~e:snake Greetings!', '~e:cat Hi!', "~e:octo Greetings, #{query.user['nickname']}!", '~e:spaceinvader Hello!'].sample
      end
    end

  end
end

@tony = DismalTony::VIBase.new
@qry = <<DOC
--- !ruby/object:DismalTony::Query
raw_text: Mix me a drink.
parsed_result: !ruby/object:ParseyParse::Sentence
words:
- &1 !ruby/object:ParseyParse::Word
id: 2
form: Mix
lemma:
pos: VERB
xpos: VB
feats:
head:
rel: ROOT
deps:
misc:
- !ruby/object:ParseyParse::Word
id: 3
form: me
lemma:
pos: PRON
xpos: PRP
feats:
head: *1
rel: iobj
deps:
misc:
- !ruby/object:ParseyParse::Word
id: 4
form: a
lemma:
pos: DET
xpos: DT
feats:
head: &2 !ruby/object:ParseyParse::Word
id: 5
form: drink
lemma:
pos: NOUN
xpos: NN
feats:
head: *1
rel: dobj
deps:
misc:
rel: det
deps:
misc:
- *2
- !ruby/object:ParseyParse::Word
id: 6
form: "."
lemma:
pos: "."
xpos: "."
feats:
head: *1
rel: punct
deps:
misc:
user: !ruby/object:DismalTony::UserIdentity
user_data:
nickname: User
first_name: Default
last_name: User
conversation_state: !ruby/object:DismalTony::ConversationState
last_recieved_time:
idle: true
next_directive:
next_method:
data:
parse_next:
timestamp: 2017-10-09 21:11:01.548131566 +00:00
previous_state: !ruby/object:DismalTony::ConversationState
last_recieved_time:
idle: true
next_directive:
next_method:
data:
parse_next:
DOC
@qry = Psych.load(@qry)

def self.interactive(debug = false)
  loop do
    print "[#{@laptop_emoji}  ]: "
    res = @tony.(gets.chomp)
    puts res.inspect if debug
  end
end

# (If you use this, don't forget to add pry to your Gemfile!)
require 'pry'
Pry.start

# require 'irb'
# IRB.start
